<script>
  let player;
  let signalChecked = false;  // Ensure signal is only checked once
  
  // Load the YouTube Iframe API script
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  const firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Create the YouTube player when API is ready
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('sirenVideo', {
      height: '100%',
      width: '100%',
      videoId: 'dMRR6yFSy5k',  // Replace with your YouTube video ID
      playerVars: {
        'autoplay': 0,  // Autoplay after delay
        'controls': 0,  // Hide controls
        'mute': 1       // Start muted to ensure autoplay works
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }

  // This function is called when the player is ready
  function onPlayerReady(event) {
    console.log("YouTube Player is ready. Waiting for the signal.");

    // Set the video quality to the highest available (1080p)
    player.setPlaybackQuality('hd1080'); // Forces 1080p quality if available

    // Start polling for the signal
    checkForSignal();
  }

  // Handle when the video ends
  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED) {
      // Redirect to the "Please Exit" screen when the video finishes
      window.location.href = 'exit.html';
    }
  }

  // Poll the server for the signal every 2 seconds
  function checkForSignal() {
    if (!signalChecked) {  // Only check once
      fetch('https://legend-oxidized-governor.glitch.me/signal')  // Replace with your Glitch URL
        .then(response => response.json())
        .then(data => {
          console.log("Signal status:", data.playVideo);  // Log signal status

          if (data.playVideo) {
            console.log("Signal received! Starting video after 2 seconds.");
            setTimeout(playVideo, 2000);  // Delay video playback by 2 seconds
            signalChecked = true;  // Stop further checks
          }
        })
        .catch(error => console.error('Error checking signal:', error));
    }
  }

  // Play the video after the delay
  function playVideo() {
    player.mute();  // Start muted to allow autoplay
    player.playVideo();  // Play the video

    // Unmute after 1 second
    setTimeout(() => {
      player.unMute();
    }, 1000);
  }
</script>
